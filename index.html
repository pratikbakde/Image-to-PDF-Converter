<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to PDF Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .image-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 60vh;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .edit-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            z-index: 10;
        }
        
        .crop-canvas {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: default;
            touch-action: none;
        }
        
        .crop-canvas.crop-mode {
            cursor: move;
        }
        
        .crop-canvas.resize-nw { cursor: nw-resize; }
        .crop-canvas.resize-ne { cursor: ne-resize; }
        .crop-canvas.resize-sw { cursor: sw-resize; }
        .crop-canvas.resize-se { cursor: se-resize; }
        .crop-canvas.resize-n { cursor: n-resize; }
        .crop-canvas.resize-s { cursor: s-resize; }
        .crop-canvas.resize-w { cursor: w-resize; }
        .crop-canvas.resize-e { cursor: e-resize; }
        
        @media (max-width: 640px) {
            .image-preview {
                max-height: 50vh;
            }
            
            .edit-overlay {
                top: 5px;
                right: 5px;
                padding: 6px 10px;
                font-size: 12px;
            }
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .controls-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-image text-blue-600"></i> Image to PDF Converter
            </h1>
            <p class="text-gray-600 text-sm sm:text-base">Capture, edit, crop, and convert images to PDF</p>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button onclick="takePhoto()" class="flex-1 btn-primary">
                    <i class="fas fa-camera mr-2"></i>Take Photo
                </button>
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 btn-success">
                    <i class="fas fa-images mr-2"></i>Choose Images
                </button>
            </div>
            
            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
            
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-gray-100 transition-colors">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600 text-sm sm:text-base">Or drag and drop images here</p>
            </div>
        </div>

        <!-- Images Preview -->
        <div id="imagesContainer" class="space-y-6 mb-6"></div>

        <!-- Convert to PDF Button -->
        <div id="convertSection" class="text-center hidden">
            <button onclick="convertToPDF()" class="btn-danger text-lg">
                <i class="fas fa-file-pdf mr-2"></i>Convert to PDF
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-2">
            <div class="bg-white rounded-lg w-full max-w-5xl modal-content">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Edit Image</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-4">
                    <!-- Image Display -->
                    <div class="image-container mb-4">
                        <canvas id="editCanvas" class="crop-canvas mx-auto"></canvas>
                    </div>
                    
                    <!-- Editing Controls -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Rotate Controls -->
                        <div class="controls-section">
                            <h4 class="font-semibold text-gray-700 mb-3 text-center">Rotate</h4>
                            <div class="flex justify-center gap-2">
                                <button onclick="rotateImage(-90)" class="btn-primary text-sm">
                                    <i class="fas fa-undo mr-1"></i>Left
                                </button>
                                <button onclick="rotateImage(90)" class="btn-primary text-sm">
                                    <i class="fas fa-redo mr-1"></i>Right
                                </button>
                            </div>
                        </div>
                        
                        <!-- Crop Controls -->
                        <div class="controls-section">
                            <h4 class="font-semibold text-gray-700 mb-3 text-center">Crop</h4>
                            <div class="flex justify-center gap-2">
                                <button id="cropBtn" onclick="toggleCrop()" class="btn-success text-sm">
                                    <i class="fas fa-crop mr-1"></i>Enable
                                </button>
                                <button onclick="applyCrop()" class="btn-primary text-sm">
                                    <i class="fas fa-check mr-1"></i>Apply
                                </button>
                            </div>
                        </div>
                        
                        <!-- Brightness Controls -->
                        <div class="controls-section">
                            <h4 class="font-semibold text-gray-700 mb-3 text-center">Brightness</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600">Dark</span>
                                <input type="range" id="brightnessSlider" min="-100" max="100" value="0" class="flex-1" oninput="adjustBrightness(this.value)">
                                <span class="text-xs text-gray-600">Bright</span>
                                <span id="brightnessValue" class="text-xs font-semibold text-gray-700 w-8 text-center">0</span>
                            </div>
                        </div>
                        
                        <!-- Saturation Controls -->
                        <div class="controls-section">
                            <h4 class="font-semibold text-gray-700 mb-3 text-center">Saturation</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600">Low</span>
                                <input type="range" id="saturationSlider" min="-100" max="100" value="0" class="flex-1" oninput="adjustSaturation(this.value)">
                                <span class="text-xs text-gray-600">High</span>
                                <span id="saturationValue" class="text-xs font-semibold text-gray-700 w-8 text-center">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 mt-6 pt-4 border-t">
                        <button onclick="resetImage()" class="flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="saveChanges()" class="flex-1 btn-success py-3 px-4">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let images = [];
        let currentEditIndex = -1;
        let originalImageData = null;
        let cropData = null;
        let isCropMode = false;
        let isDragging = false;
        let dragMode = 'move';
        let startX = 0;
        let startY = 0;
        let rotation = 0;
        let brightness = 0;
        let saturation = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const cameraInput = document.getElementById('cameraInput');
            const dropZone = document.getElementById('dropZone');

            fileInput.addEventListener('change', handleFiles);
            cameraInput.addEventListener('change', handleFiles);

            // Drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                handleFiles({ target: { files: e.dataTransfer.files } });
            });

            // Canvas event listeners
            setupCanvasEvents();
        });

        function setupCanvasEvents() {
            const canvas = document.getElementById('editCanvas');
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', endDrag);
            canvas.addEventListener('mouseleave', endDrag);
            
            // Touch events
            canvas.addEventListener('touchstart', startDragTouch);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', endDrag);
        }

        function takePhoto() {
            document.getElementById('cameraInput').click();
        }

        function handleFiles(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            images.push({
                                src: e.target.result,
                                canvas: null,
                                originalImage: img
                            });
                            displayImages();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function displayImages() {
            const container = document.getElementById('imagesContainer');
            const convertSection = document.getElementById('convertSection');
            
            container.innerHTML = '';
            
            if (images.length === 0) {
                convertSection.classList.add('hidden');
                return;
            }

            convertSection.classList.remove('hidden');

            images.forEach((image, index) => {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'bg-white rounded-lg shadow-lg p-4';
                imageDiv.innerHTML = `
                    <div class="image-container">
                        <img src="${image.src}" alt="Image ${index + 1}" class="image-preview">
                        <div class="edit-overlay" onclick="editImage(${index})">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-sm text-gray-600">Image ${index + 1}</span>
                        <button onclick="removeImage(${index})" class="text-red-600 hover:text-red-800 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(imageDiv);
            });
        }

        function editImage(index) {
            currentEditIndex = index;
            const image = images[index];
            
            // Reset edit parameters
            rotation = 0;
            brightness = 0;
            saturation = 0;
            
            // Reset sliders
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('saturationSlider').value = 0;
            document.getElementById('brightnessValue').textContent = '0';
            document.getElementById('saturationValue').textContent = '0';
            
            // Setup canvas
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const maxWidth = 600;
            const maxHeight = 400;
            let { width, height } = image.originalImage;
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // Store original image data
            originalImageData = canvas.toDataURL();
            
            // Draw image
            ctx.drawImage(image.originalImage, 0, 0, width, height);
            
            // Show modal
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            currentEditIndex = -1;
            isCropMode = false;
            cropData = null;
            isDragging = false;
        }

        function rotateImage(degrees) {
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            const image = images[currentEditIndex].originalImage;
            
            rotation = (rotation + degrees) % 360;
            redrawImage();
        }

        function adjustBrightness(value) {
            brightness = parseInt(value);
            document.getElementById('brightnessValue').textContent = value;
            redrawImage();
        }

        function adjustSaturation(value) {
            saturation = parseInt(value);
            document.getElementById('saturationValue').textContent = value;
            redrawImage();
        }

        function redrawImage() {
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            const image = images[currentEditIndex].originalImage;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context
            ctx.save();
            
            // Apply rotation
            if (rotation !== 0) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate((rotation * Math.PI) / 180);
                ctx.translate(-canvas.width / 2, -canvas.height / 2);
            }
            
            // Draw image
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            
            // Apply brightness and saturation
            if (brightness !== 0 || saturation !== 0) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    // Brightness
                    data[i] = Math.max(0, Math.min(255, data[i] + brightness));
                    data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + brightness));
                    data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + brightness));
                    
                    // Saturation
                    if (saturation !== 0) {
                        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        const satFactor = (100 + saturation) / 100;
                        data[i] = Math.max(0, Math.min(255, gray + (data[i] - gray) * satFactor));
                        data[i + 1] = Math.max(0, Math.min(255, gray + (data[i + 1] - gray) * satFactor));
                        data[i + 2] = Math.max(0, Math.min(255, gray + (data[i + 2] - gray) * satFactor));
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            // Restore context
            ctx.restore();
            
            // Draw crop overlay if in crop mode
            if (isCropMode && cropData) {
                drawCropOverlay();
            }
        }

        function toggleCrop() {
            isCropMode = !isCropMode;
            const btn = document.getElementById('cropBtn');
            const canvas = document.getElementById('editCanvas');
            
            if (isCropMode) {
                btn.innerHTML = '<i class="fas fa-times mr-1"></i>Cancel';
                btn.className = 'btn-danger text-sm';
                canvas.classList.add('crop-mode');
                initCrop();
            } else {
                btn.innerHTML = '<i class="fas fa-crop mr-1"></i>Enable';
                btn.className = 'btn-success text-sm';
                canvas.classList.remove('crop-mode');
                removeCrop();
            }
        }

        function initCrop() {
            const canvas = document.getElementById('editCanvas');
            cropData = {
                x: canvas.width * 0.1,
                y: canvas.height * 0.1,
                width: canvas.width * 0.8,
                height: canvas.height * 0.8
            };
            drawCropOverlay();
        }

        function drawCropOverlay() {
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!cropData) return;
            
            ctx.save();
            
            // Draw semi-transparent overlay
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Clear crop area
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillRect(cropData.x, cropData.y, cropData.width, cropData.height);
            
            // Draw crop border
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(cropData.x, cropData.y, cropData.width, cropData.height);
            
            // Draw resize handles
            ctx.fillStyle = '#3b82f6';
            ctx.setLineDash([]);
            const handleSize = 8;
            
            // Corner handles
            ctx.fillRect(cropData.x - handleSize/2, cropData.y - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x + cropData.width - handleSize/2, cropData.y - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x - handleSize/2, cropData.y + cropData.height - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x + cropData.width - handleSize/2, cropData.y + cropData.height - handleSize/2, handleSize, handleSize);
            
            // Edge handles
            ctx.fillRect(cropData.x + cropData.width/2 - handleSize/2, cropData.y - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x + cropData.width/2 - handleSize/2, cropData.y + cropData.height - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x - handleSize/2, cropData.y + cropData.height/2 - handleSize/2, handleSize, handleSize);
            ctx.fillRect(cropData.x + cropData.width - handleSize/2, cropData.y + cropData.height/2 - handleSize/2, handleSize, handleSize);
            
            ctx.restore();
        }

        function getMousePos(canvas, e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function getTouchPos(canvas, e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.touches[0].clientX - rect.left) * (canvas.width / rect.width),
                y: (e.touches[0].clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function getResizeMode(x, y) {
            if (!cropData) return 'none';
            
            const handleSize = 8;
            const tolerance = handleSize;
            
            // Check corner handles
            if (Math.abs(x - cropData.x) < tolerance && Math.abs(y - cropData.y) < tolerance) return 'nw';
            if (Math.abs(x - (cropData.x + cropData.width)) < tolerance && Math.abs(y - cropData.y) < tolerance) return 'ne';
            if (Math.abs(x - cropData.x) < tolerance && Math.abs(y - (cropData.y + cropData.height)) < tolerance) return 'sw';
            if (Math.abs(x - (cropData.x + cropData.width)) < tolerance && Math.abs(y - (cropData.y + cropData.height)) < tolerance) return 'se';
            
            // Check edge handles
            if (Math.abs(x - (cropData.x + cropData.width/2)) < tolerance && Math.abs(y - cropData.y) < tolerance) return 'n';
            if (Math.abs(x - (cropData.x + cropData.width/2)) < tolerance && Math.abs(y - (cropData.y + cropData.height)) < tolerance) return 's';
            if (Math.abs(x - cropData.x) < tolerance && Math.abs(y - (cropData.y + cropData.height/2)) < tolerance) return 'w';
            if (Math.abs(x - (cropData.x + cropData.width)) < tolerance && Math.abs(y - (cropData.y + cropData.height/2)) < tolerance) return 'e';
            
            // Check if inside crop area
            if (x >= cropData.x && x <= cropData.x + cropData.width && y >= cropData.y && y <= cropData.y + cropData.height) {
                return 'move';
            }
            
            return 'none';
        }

        function startDrag(e) {
            if (!isCropMode) return;
            
            const canvas = document.getElementById('editCanvas');
            const pos = getMousePos(canvas, e);
            
            dragMode = getResizeMode(pos.x, pos.y);
            if (dragMode === 'none') return;
            
            isDragging = true;
            startX = pos.x;
            startY = pos.y;
            
            e.preventDefault();
        }

        function startDragTouch(e) {
            if (!isCropMode) return;
            
            const canvas = document.getElementById('editCanvas');
            const pos = getTouchPos(canvas, e);
            
            dragMode = getResizeMode(pos.x, pos.y);
            if (dragMode === 'none') return;
            
            isDragging = true;
            startX = pos.x;
            startY = pos.y;
            
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!isCropMode) return;
            
            const canvas = document.getElementById('editCanvas');
            const pos = getMousePos(canvas, e);
            
            if (isDragging) {
                updateCropArea(pos.x, pos.y);
            } else {
                updateCursor(pos.x, pos.y);
            }
        }

        function handleTouchMove(e) {
            if (!isCropMode) return;
            
            const canvas = document.getElementById('editCanvas');
            const pos = getTouchPos(canvas, e);
            
            if (isDragging) {
                updateCropArea(pos.x, pos.y);
            }
            
            e.preventDefault();
        }

        function updateCursor(x, y) {
            const canvas = document.getElementById('editCanvas');
            const mode = getResizeMode(x, y);
            
            canvas.className = 'crop-canvas crop-mode';
            
            switch (mode) {
                case 'nw': case 'se': canvas.classList.add('resize-nw'); break;
                case 'ne': case 'sw': canvas.classList.add('resize-ne'); break;
                case 'n': case 's': canvas.classList.add('resize-n'); break;
                case 'w': case 'e': canvas.classList.add('resize-w'); break;
                case 'move': canvas.style.cursor = 'move'; break;
                default: canvas.style.cursor = 'default';
            }
        }

        function updateCropArea(x, y) {
            if (!cropData) return;
            
            const deltaX = x - startX;
            const deltaY = y - startY;
            
            const canvas = document.getElementById('editCanvas');
            const minSize = 20;
            
            switch (dragMode) {
                case 'move':
                    cropData.x = Math.max(0, Math.min(canvas.width - cropData.width, cropData.x + deltaX));
                    cropData.y = Math.max(0, Math.min(canvas.height - cropData.height, cropData.y + deltaY));
                    break;
                case 'nw':
                    const newX = Math.max(0, Math.min(cropData.x + cropData.width - minSize, cropData.x + deltaX));
                    const newY = Math.max(0, Math.min(cropData.y + cropData.height - minSize, cropData.y + deltaY));
                    cropData.width += cropData.x - newX;
                    cropData.height += cropData.y - newY;
                    cropData.x = newX;
                    cropData.y = newY;
                    break;
                case 'ne':
                    cropData.width = Math.max(minSize, Math.min(canvas.width - cropData.x, cropData.width + deltaX));
                    const newY2 = Math.max(0, Math.min(cropData.y + cropData.height - minSize, cropData.y + deltaY));
                    cropData.height += cropData.y - newY2;
                    cropData.y = newY2;
                    break;
                case 'sw':
                    const newX2 = Math.max(0, Math.min(cropData.x + cropData.width - minSize, cropData.x + deltaX));
                    cropData.width += cropData.x - newX2;
                    cropData.x = newX2;
                    cropData.height = Math.max(minSize, Math.min(canvas.height - cropData.y, cropData.height + deltaY));
                    break;
                case 'se':
                    cropData.width = Math.max(minSize, Math.min(canvas.width - cropData.x, cropData.width + deltaX));
                    cropData.height = Math.max(minSize, Math.min(canvas.height - cropData.y, cropData.height + deltaY));
                    break;
                case 'n':
                    const newY3 = Math.max(0, Math.min(cropData.y + cropData.height - minSize, cropData.y + deltaY));
                    cropData.height += cropData.y - newY3;
                    cropData.y = newY3;
                    break;
                case 's':
                    cropData.height = Math.max(minSize, Math.min(canvas.height - cropData.y, cropData.height + deltaY));
                    break;
                case 'w':
                    const newX3 = Math.max(0, Math.min(cropData.x + cropData.width - minSize, cropData.x + deltaX));
                    cropData.width += cropData.x - newX3;
                    cropData.x = newX3;
                    break;
                case 'e':
                    cropData.width = Math.max(minSize, Math.min(canvas.width - cropData.x, cropData.width + deltaX));
                    break;
            }
            
            startX = x;
            startY = y;
            
            redrawImage();
        }

        function endDrag() {
            isDragging = false;
            dragMode = 'none';
        }

        function applyCrop() {
            if (!cropData) return;
            
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            
            // Get image data from crop area
            const imageData = ctx.getImageData(cropData.x, cropData.y, cropData.width, cropData.height);
            
            // Resize canvas to crop size
            canvas.width = cropData.width;
            canvas.height = cropData.height;
            
            // Put cropped image data
            ctx.putImageData(imageData, 0, 0);
            
            // Exit crop mode
            toggleCrop();
        }

        function removeCrop() {
            const canvas = document.getElementById('editCanvas');
            canvas.className = 'crop-canvas';
            cropData = null;
            redrawImage();
        }

        function resetImage() {
            rotation = 0;
            brightness = 0;
            saturation = 0;
            
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('saturationSlider').value = 0;
            document.getElementById('brightnessValue').textContent = '0';
            document.getElementById('saturationValue').textContent = '0';
            
            const canvas = document.getElementById('editCanvas');
            const ctx = canvas.getContext('2d');
            const image = images[currentEditIndex].originalImage;
            
            // Reset canvas size
            const maxWidth = 600;
            const maxHeight = 400;
            let { width, height } = image;
            
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(image, 0, 0, width, height);
            
            removeCrop();
        }

        function saveChanges() {
            const canvas = document.getElementById('editCanvas');
            images[currentEditIndex].src = canvas.toDataURL();
            
            // Update the displayed image
            displayImages();
            closeEditModal();
        }

        function removeImage(index) {
            if (confirm('Are you sure you want to remove this image?')) {
                images.splice(index, 1);
                displayImages();
            }
        }

        function convertToPDF() {
            if (images.length === 0) {
                alert('Please add some images first!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            let loadedImages = 0;
            
            images.forEach((image, index) => {
                const img = new Image();
                img.onload = () => {
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10;
                    
                    const availableWidth = pageWidth - (margin * 2);
                    const availableHeight = pageHeight - (margin * 2);
                    
                    const imgWidth = img.width;
                    const imgHeight = img.height;
                    const ratio = Math.min(availableWidth / imgWidth, availableHeight / imgHeight);
                    
                    const finalWidth = imgWidth * ratio;
                    const finalHeight = imgHeight * ratio;
                    
                    const x = (pageWidth - finalWidth) / 2;
                    const y = (pageHeight - finalHeight) / 2;
                    
                    if (index > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(image.src, 'JPEG', x, y, finalWidth, finalHeight);
                    
                    loadedImages++;
                    if (loadedImages === images.length) {
                        const filename = `converted_images_${new Date().toISOString().slice(0, 10)}.pdf`;
                        pdf.save(filename);
                    }
                };
                img.src = image.src;
            });
        }
    </script>
</body>
</html> 
